@model Transpo.WebApp.Models.SetPasswordViewModel
@{
    //ViewBag.Title = "Create Password";
    Layout = null;
}

@*<h2>@ViewBag.Title.</h2>*@
<p class="text-info">
    You do not have a local username/password for this site. Add a local
    account so you can log in without an external login.
</p>

@using (Html.BeginForm("SetPassword", "Manage", FormMethod.Post, new { @class = "ui form setpasswordform", role = "form" }))
{
    @Html.AntiForgeryToken()

    <h4 class="ui dividing header">Create Local Login</h4>
    
    @Html.ValidationSummary(true, "", new { @class = "ui error message", @style = "display:block;" })

    <div class="ui grid">
        <div class="four wide column">
            <div class="field">
                @Html.LabelFor(m => m.NewPassword)
                @Html.PasswordFor(m => m.NewPassword)
            </div>
            <div class="field">
                @Html.LabelFor(m => m.ConfirmPassword)
                @Html.PasswordFor(m => m.ConfirmPassword)
            </div>
            <button type="submit" value="Set password" class="ui button primary" id="btnSetPassword">Set Password</button>
        </div>
    </div>

}

<script>
    $.fn.form.settings.rules.matchPasswords = function (value) {
        return $('[name="NewPassword"]').val() === value;
    }

    $('.ui.form.setpasswordform').form({
        fields: {
            password: {
                identifier: 'NewPassword',
                rules: [
                {
                    type: 'empty',
                    prompt: 'Please enter a new password'
                },
                {
                    type: 'length[6]',
                    prompt: 'Your password must be at least 6 characters'
                }
                ]
            },
            confirmPassword: {
                identifier: 'ConfirmPassword',
                rules: [
                {
                    type: 'empty',
                    prompt: 'Please confirm the password'
                },
                {
                    type: 'matchPasswords',
                    prompt: 'Your passwords must match'
                }
                ]
            }
        },
        inline: true,
        onSuccess: function (e, data) {
            e.preventDefault();
            $('#btnSetPassword').addClass('loading');

            var data = {
                __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val(),
                model: {
                    NewPassword: $('[name="NewPassword"]').val(),
                    ConfirmPassword: $('[name="ConfirmPassword"]').val()
                }
            };

            $.ajax({
                type: 'POST',
                url: '@Url.Action("SetPassword", "Manage")',
                data: data,
                success: function (data) {
                    window.location.reload();
                }
            })
        }
    });
</script>